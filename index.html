<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family:sans-serif;
  background:#f2f2f2;
  margin:0;
  padding:8px;
}
.app {
  max-width:360px;
  margin:0 auto;
}

/* ---------- TOP HEADER ---------- */
.header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:#fff;
  padding:10px 12px;
  border-radius:10px;
  margin-bottom:14px;
  box-shadow:0 1px 3px rgba(0,0,0,.08);
}

.logo {
  height:120px;          /* VERY BIG LOGO */
  max-width:60%;
  object-fit:contain;
}

.userbar {
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:6px;
  font-size:12px;
}

.userline {
  display:flex;
  align-items:center;
  gap:8px;
}

.avatar {
  width:32px;
  height:32px;
  border-radius:50%;
  object-fit:cover;
  display:none;
}

.actions {
  display:flex;
  gap:6px;
}

.btn {
  font-size:12px;
  padding:5px 12px;
  border-radius:6px;
  border:1px solid #bbb;
  background:#fff;
  cursor:pointer;
}

.btn.primary {
  background:#f5f5f5;
}

.btn.edit-on {
  background:#ffecb3;
  border-color:#ff9800;
}

/* ---------- CARDS ---------- */
.card {
  background:#fff;
  border-radius:8px;
  padding:8px;
  margin-bottom:8px;
  border:2px solid transparent;
  box-shadow:0 1px 3px rgba(0,0,0,.08);
}
.card.free { background:#e8f5e9; border-color:#4caf50; }
.card.assigned { border-color:#e53935; }
.card.unavailable { background:#eee; border-color:#9e9e9e; }

.row {
  display:flex;
  gap:10px;
  align-items:flex-start;
}

img.bike {
  width:130px;
}

.name {
  font-size:13px;
  font-weight:600;
  margin-top:4px;
}

.updated {
  font-size:11px;
  color:#777;
  margin-top:2px;
}

select {
  width:100%;
  font-size:13px;
  padding:4px;
}

/* ---------- INFO ---------- */
.info {
  font-size:11px;
  color:#555;
  line-height:1.6;
}
.info div { margin-bottom:6px; }

.warn { color:#ff9800; animation:flash 1.2s infinite; }
.expired { color:#e53935; font-weight:600; }

@keyframes flash {
  0%{opacity:1} 50%{opacity:.3} 100%{opacity:1}
}

input.date {
  width:100%;
  font-size:11px;
  padding:2px;
}
</style>
</head>

<body>

<div class="app">

<!-- HEADER -->
<div class="header">
  <img src="Logo.png" class="logo" alt="Logo">

  <div class="userbar">
    <div class="userline">
      <img id="avatar" class="avatar">
      <strong id="username">—</strong>
    </div>
    <div class="actions">
      <button id="loginBtn" class="btn primary" onclick="signIn()">Login</button>
      <button id="logoutBtn" class="btn" onclick="signOut()" style="display:none">Logout</button>
      <button id="editBtn" class="btn" onclick="toggleEdit()" style="display:none">Edit</button>
    </div>
  </div>
</div>

<div id="bikes"></div>

</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyCqJ-LqV_hn06MhfweOTJGIDmIt5bIq2JI",
  authDomain: "baan-namsai-bikes.firebaseapp.com",
  projectId: "baan-namsai-bikes"
});
const auth = firebase.auth();
const db = firebase.firestore();

/* CONFIG */
const ADMIN_UID = "pK46rxDcvEVZEyktMvc8g2FaCoH2";
let editMode = false;
let pendingStatus = null;

const bikes = [
  { id:1, name:"Honda Click", img:"click_redblack.png", plate:"1กต 8316" },
  { id:2, name:"Yamaha Fazzio grey", img:"fazzio_darkgrey.png", plate:"1กร 5287" },
  { id:3, name:"Yamaha Fazzio blue", img:"fazzio_lightblue.png", plate:"1กพ 2670" }
];

/* AUTH */
auth.onAuthStateChanged(user=>{
  const avatar = document.getElementById("avatar");
  const username = document.getElementById("username");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const editBtn = document.getElementById("editBtn");

  if(user){
    username.innerText = user.displayName || "User";
    avatar.src = user.photoURL || "";
    avatar.style.display = user.photoURL ? "block" : "none";
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
    editBtn.style.display = (user.uid === ADMIN_UID) ? "inline-block" : "none";

    if(pendingStatus){
      applyStatus(pendingStatus.id, pendingStatus.value);
      pendingStatus = null;
    }
  } else {
    username.innerText = "—";
    avatar.style.display = "none";
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    editBtn.style.display = "none";
    editMode = false;
    editBtn.classList.remove("edit-on");
  }
});

/* AUTH ACTIONS */
function signIn(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}
function signOut(){
  auth.signOut();
}

/* ---------- EVERYTHING BELOW UNCHANGED ---------- */
/* (dates, rendering, Firestore sync, edit mode, etc.) */

function parseDate(str){
  if(!str) return null;
  if(str.includes("-")) return new Date(str+"T00:00:00");
  const [d,m,y] = str.split("/").map(Number);
  return new Date(2000+y, m-1, d);
}
function daysLeft(str){
  const d=parseDate(str);
  if(!d) return NaN;
  return Math.ceil((d-new Date())/86400000);
}
function remaining(days){
  if(isNaN(days)) return "";
  if(days<0) return "Expired / หมดอายุ";
  if(days<=14) return days+" days / วัน";
  if(days<60) return days+" days / วัน";
  return Math.round(days/30)+" months / เดือน";
}
function timeAgo(ts){
  const s=Math.floor((Date.now()-ts)/1000);
  if(s<3600) return Math.floor(s/60)+" min ago";
  if(s<86400) return Math.floor(s/3600)+" h ago";
  const d=new Date(ts);
  return `${Math.floor(s/86400)} d ago · ${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getFullYear()).slice(-2)} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
}

function toggleEdit(){
  editMode=!editMode;
  document.getElementById("editBtn").classList.toggle("edit-on",editMode);
  rerenderAll();
}

function renderBike(b){
  return `
  <div class="card" id="bike${b.id}-card">
    <div class="row">
      <img src="${b.img}" class="bike">
      <div class="info" id="bike${b.id}-expiry"></div>
    </div>
    <div class="name">${b.name}</div>
    <select onchange="saveStatus(${b.id},this.value)">
      <option value="Free">Free / ว่าง</option>
      <option>Baan Mai / บ้านไม้</option>
      <option>Baan Nam Lom / บ้านลมและน้ำ</option>
      <option>Baan Mai Pai / บ้านไม้ไผ่</option>
      <option>Baan Makham / บ้านมะขาม</option>
      <option value="Unavailable">Unavailable / ไม่พร้อมใช้งาน</option>
    </select>
    <div class="updated" id="bike${b.id}-time"></div>
  </div>`;
}

document.getElementById("bikes").innerHTML=bikes.map(renderBike).join("");

function expiryBlock(bikeId,d,plate){
  const taxDays=daysLeft(d.taxExpiry);
  const insDays=daysLeft(d.insuranceExpiry);
  function line(label,field,days,value){
    let cls="";
    if(days<0) cls="expired";
    else if(days<=14) cls="warn";
    if(editMode){
      const dt=parseDate(value);
      const v=dt?`${String(dt.getDate()).padStart(2,"0")}/${String(dt.getMonth()+1).padStart(2,"0")}/${String(dt.getFullYear()).slice(-2)}`:"";
      return `<div class="${cls}">${label}: <input class="date" value="${v}"
      onchange="updateExpiry('${bikeId}','${field}',this.value)"></div>`;
    }
    return `<div class="${cls}">${label}: ${remaining(days)}</div>`;
  }
  return `
    ${line("Tax / ภาษี","taxExpiry",taxDays,d.taxExpiry)}
    ${line("Insurance / ประกัน","insuranceExpiry",insDays,d.insuranceExpiry)}
    <div>Plate / ทะเบียน: ${plate}</div>
  `;
}

bikes.forEach(b=>{
  db.collection("bikes").doc("bike"+b.id).onSnapshot(doc=>{
    if(!doc.exists) return;
    const d=doc.data();
    const card=document.getElementById("bike"+b.id+"-card");
    const sel=card.querySelector("select");
    sel.value=d.status;
    card.classList.remove("free","assigned","unavailable");
    if(d.status==="Free") card.classList.add("free");
    else if(d.status==="Unavailable") card.classList.add("unavailable");
    else card.classList.add("assigned");

    if(d.updatedAt?.toMillis){
      document.getElementById("bike"+b.id+"-time").innerText=
        "Updated "+timeAgo(d.updatedAt.toMillis())+
        (d.updatedBy?" by "+d.updatedBy:"");
    }
    document.getElementById("bike"+b.id+"-expiry").innerHTML=
      expiryBlock("bike"+b.id,d,b.plate);
  });
});

function rerenderAll(){
  bikes.forEach(b=>{
    db.collection("bikes").doc("bike"+b.id).get().then(doc=>{
      if(doc.exists){
        document.getElementById("bike"+b.id+"-expiry").innerHTML=
          expiryBlock("bike"+b.id,doc.data(),b.plate);
      }
    });
  });
}

function saveStatus(id,val){
  if(!auth.currentUser){
    pendingStatus={id,value:val};
    signIn();
    return;
  }
  applyStatus(id,val);
}
function applyStatus(id,val){
  db.collection("bikes").doc("bike"+id).update({
    status:val,
    updatedAt:firebase.firestore.FieldValue.serverTimestamp(),
    updatedBy:auth.currentUser.displayName
  });
}
function updateExpiry(bikeId,field,val){
  if(!editMode) return;
  db.collection("bikes").doc(bikeId).update({[field]:val});
}
</script>

</body>
</html>

