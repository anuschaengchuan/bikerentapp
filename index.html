/* ================= AUTH with OPTIMISTIC RENDER ================= */
function getCachedUser(){
  try { return JSON.parse(localStorage.getItem("authCache")); }
  catch { return null; }
}

const cachedUser = getCachedUser();
if(cachedUser){
  avatar.src = cachedUser.photoURL || "";
  avatar.style.display = cachedUser.photoURL ? "block" : "none";
  loginBtn.style.display = "none";
  logoutBtn.style.display = "inline-block";
  editBtn.style.display = cachedUser.uid === ADMIN_UID ? "inline-block" : "none";
} else {
  avatar.style.display = "none";
  loginBtn.style.display = "inline-block";
  logoutBtn.style.display = "none";
  editBtn.style.display = "none";
}

auth.onAuthStateChanged(user=>{
  if(user){
    localStorage.setItem("authCache", JSON.stringify({
      uid: user.uid,
      photoURL: user.photoURL,
      displayName: user.displayName
    }));
    avatar.src=user.photoURL||"";
    avatar.style.display=user.photoURL?"block":"none";
    loginBtn.style.display="none";
    logoutBtn.style.display="inline-block";
    editBtn.style.display=user.uid===ADMIN_UID?"inline-block":"none";
  } else {
    localStorage.removeItem("authCache");
    avatar.style.display="none";
    loginBtn.style.display="inline-block";
    logoutBtn.style.display="none";
    editBtn.style.display="none";
    editMode=false;
  }
  updateHeader();
});
