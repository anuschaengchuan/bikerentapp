<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family:sans-serif;
  background:#f2f2f2;
  margin:0;
  padding:8px;
}
.app {
  max-width:360px;
  margin:0 auto;
}

/* ---------- HEADER ---------- */
.header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:#fff;
  padding:12px;
  border-radius:10px;
  margin-bottom:12px;
  box-shadow:0 1px 3px rgba(0,0,0,.08);
}

.logo {
  height:80px;
}

/* ---------- RIGHT ---------- */
.right {
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:6px;
  font-size:12px;
}

.lang-switch {
  display:flex;
  align-items:center;
  gap:6px;
  cursor:pointer;
}

.lang-switch span.flag {
  font-size:20px;
}

.userline {
  display:flex;
  align-items:center;
  gap:8px;
}

.avatar {
  width:32px;
  height:32px;
  border-radius:50%;
  object-fit:cover;
  display:none;
}

.actions {
  display:flex;
  gap:8px;
  align-items:center;
}

.btn {
  font-size:13px;
  padding:7px 16px;
  border-radius:6px;
  border:1px solid #bbb;
  background:#fff;
  cursor:pointer;
}

.btn.edit-on {
  background:#ffecb3;
  border-color:#ff9800;
}

/* ---------- CARDS ---------- */
.card {
  background:#fff;
  border-radius:8px;
  padding:8px;
  margin-bottom:8px;
  border:2px solid transparent;
  box-shadow:0 1px 3px rgba(0,0,0,.08);
}
.card.free { background:#e8f5e9; border-color:#4caf50; }
.card.assigned { border-color:#e53935; }
.card.unavailable { background:#eee; border-color:#9e9e9e; }

.row {
  display:flex;
  gap:10px;
}

img.bike { width:130px; }

.name { font-size:13px; font-weight:600; margin-top:4px; }
.updated { font-size:11px; color:#777; margin-top:2px; }

select { width:100%; font-size:13px; padding:4px; }

/* ---------- INFO ---------- */
.info { font-size:11px; color:#555; line-height:1.6; }
.info div { margin-bottom:6px; }

.warn { color:#ff9800; animation:flash 1.2s infinite; }
.expired { color:#e53935; font-weight:600; }

@keyframes flash {
  0%{opacity:1} 50%{opacity:.3} 100%{opacity:1}
}
</style>
</head>

<body>

<div class="app">

<div class="header">
  <img src="Logo.png" class="logo">

  <div class="right">
    <div class="lang-switch" onclick="toggleLang()">
      <span id="langText"></span>
      <span class="flag" id="langFlag"></span>
    </div>

    <div class="actions">
      <img id="avatar" class="avatar">
      <button id="loginBtn" class="btn" onclick="signIn()"></button>
      <button id="logoutBtn" class="btn" onclick="signOut()" style="display:none"></button>
      <button id="editBtn" class="btn" onclick="toggleEdit()" style="display:none">Edit</button>
    </div>
  </div>
</div>

<div id="bikes"></div>

</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* ---------- LANGUAGE ---------- */
const browserLang = navigator.language.startsWith("th") ? "th" : "en";
let lang = localStorage.getItem("lang") || browserLang;

const T = {
  en:{
    available:"Available",
    unavailable:"Unavailable",
    tax:"Tax",
    insurance:"Insurance",
    plate:"Plate",
    expired:"Expired",
    days:"days",
    months:"months",
    login:"Login",
    logout:"Logout",
    by:"by",
    houses:{
      "Baan Mai":"Wooden House",
      "Baan Nam Lom":"Wind Water House",
      "Baan Mai Pai":"Bamboo House",
      "Baan Makham":"Tamarind House"
    }
  },
  th:{
    available:"à¸§à¹ˆà¸²à¸‡",
    unavailable:"à¹„à¸¡à¹ˆà¸žà¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™",
    tax:"à¸ à¸²à¸©à¸µ",
    insurance:"à¸›à¸£à¸°à¸à¸±à¸™",
    plate:"à¸—à¸°à¹€à¸šà¸µà¸¢à¸™",
    expired:"à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸",
    days:"à¸§à¸±à¸™",
    months:"à¹€à¸”à¸·à¸­à¸™",
    login:"à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š",
    logout:"à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š",
    by:"à¹‚à¸”à¸¢",
    houses:{
      "Baan Mai":"à¸šà¹‰à¸²à¸™à¹„à¸¡à¹‰",
      "Baan Nam Lom":"à¸šà¹‰à¸²à¸™à¸¥à¸¡à¹à¸¥à¸°à¸™à¹‰à¸³",
      "Baan Mai Pai":"à¸šà¹‰à¸²à¸™à¹„à¸¡à¹‰à¹„à¸œà¹ˆ",
      "Baan Makham":"à¸šà¹‰à¸²à¸™à¸¡à¸°à¸‚à¸²à¸¡"
    }
  }
};

function toggleLang(){
  lang = lang==="en"?"th":"en";
  localStorage.setItem("lang",lang);
  updateLangUI();
  updateAllText();
}

function updateLangUI(){
  document.getElementById("langText").innerText =
    lang==="en" ? "à¹„à¸—à¸¢" : "English";
  document.getElementById("langFlag").innerText =
    lang==="en" ? "ðŸ‡¹ðŸ‡­" : "ðŸ‡¬ðŸ‡§";

  document.getElementById("loginBtn").innerText = T[lang].login;
  document.getElementById("logoutBtn").innerText = T[lang].logout;
}

/* ---------- FIREBASE ---------- */
firebase.initializeApp({
  apiKey:"AIzaSyCqJ-LqV_hn06MhfweOTJGIDmIt5bIq2JI",
  authDomain:"baan-namsai-bikes.firebaseapp.com",
  projectId:"baan-namsai-bikes"
});
const auth=firebase.auth();
const db=firebase.firestore();

const ADMIN_UID="pK46rxDcvEVZEyktMvc8g2FaCoH2";
let editMode=false;
let pendingStatus=null;

const bikes=[
  {id:1,name:"Honda Click",img:"click_redblack.png",plate:"1à¸à¸• 8316"},
  {id:2,name:"Yamaha Fazzio",img:"fazzio_darkgrey.png",plate:"1à¸à¸£ 5287"},
  {id:3,name:"Yamaha Fazzio",img:"fazzio_lightblue.png",plate:"1à¸à¸ž 2670"}
];

/* ---------- AUTH ---------- */
auth.onAuthStateChanged(user=>{
  const avatar=document.getElementById("avatar");
  if(user){
    avatar.src=user.photoURL||"";
    avatar.style.display=user.photoURL?"block":"none";
    loginBtn.style.display="none";
    logoutBtn.style.display="inline-block";
    editBtn.style.display=user.uid===ADMIN_UID?"inline-block":"none";
    if(pendingStatus){ applyStatus(pendingStatus.id,pendingStatus.value); pendingStatus=null; }
  } else {
    avatar.style.display="none";
    loginBtn.style.display="inline-block";
    logoutBtn.style.display="none";
    editBtn.style.display="none";
  }
  updateLangUI();
});

function signIn(){ auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
function signOut(){ auth.signOut(); }

/* ---------- HELPERS ---------- */
function parseDate(str){
  if(!str) return null;
  if(str.includes("-")) return new Date(str+"T00:00:00");
  const [d,m,y]=str.split("/").map(Number);
  return new Date(2000+y,m-1,d);
}
function daysLeft(str){
  const d=parseDate(str);
  if(!d) return NaN;
  return Math.ceil((d-new Date())/86400000);
}
function remaining(days){
  if(isNaN(days)) return "";
  if(days<0) return T[lang].expired;
  if(days<60) return days+" "+T[lang].days;
  return Math.round(days/30)+" "+T[lang].months;
}
function timeAgo(ts){
  const s=Math.floor((Date.now()-ts)/1000);
  if(s<3600) return Math.floor(s/60)+" min";
  if(s<86400) return Math.floor(s/3600)+" h";
  return Math.floor(s/86400)+" d";
}

/* ---------- UI ---------- */
function toggleEdit(){
  editMode=!editMode;
  editBtn.classList.toggle("edit-on",editMode);
}

document.getElementById("bikes").innerHTML=bikes.map(b=>`
  <div class="card" id="bike${b.id}-card">
    <div class="row">
      <img src="${b.img}" class="bike">
      <div class="info" id="bike${b.id}-info"></div>
    </div>
    <div class="name">${b.name}</div>
    <select id="bike${b.id}-select"></select>
    <div class="updated" id="bike${b.id}-time"></div>
  </div>
`).join("");

function updateAllText(){
  bikes.forEach(b=>{
    const s=document.getElementById(`bike${b.id}-select`);
    s.innerHTML=`
      <option value="Free">${T[lang].available}</option>
      ${Object.entries(T[lang].houses).map(([k,v])=>`<option value="${k}">${v}</option>`).join("")}
      <option value="Unavailable">${T[lang].unavailable}</option>
    `;
    s.onchange=()=>saveStatus(b.id,s.value);
  });
}

updateLangUI();
updateAllText();

bikes.forEach(b=>{
  db.collection("bikes").doc("bike"+b.id).onSnapshot(doc=>{
    if(!doc.exists) return;
    const d=doc.data();
    const card=document.getElementById(`bike${b.id}-card`);
    const sel=document.getElementById(`bike${b.id}-select`);

    sel.value=d.status;
    card.className="card";
    if(d.status==="Free") card.classList.add("free");
    else if(d.status==="Unavailable") card.classList.add("unavailable");
    else card.classList.add("assigned");

    document.getElementById(`bike${b.id}-time`).innerText =
      d.updatedAt?.toMillis ? `${timeAgo(d.updatedAt.toMillis())} ${T[lang].by} ${d.updatedBy||""}` : "";

    document.getElementById(`bike${b.id}-info`).innerHTML=`
      <div>${T[lang].tax}: ${remaining(daysLeft(d.taxExpiry))}</div>
      <div>${T[lang].insurance}: ${remaining(daysLeft(d.insuranceExpiry))}</div>
      <div>${T[lang].plate}: ${b.plate}</div>
    `;
  });
});

/* ---------- SAVE ---------- */
function saveStatus(id,val){
  if(!auth.currentUser){ pendingStatus={id,value:val}; signIn(); return; }
  applyStatus(id,val);
}
function applyStatus(id,val){
  db.collection("bikes").doc("bike"+id).update({
    status:val,
    updatedAt:firebase.firestore.FieldValue.serverTimestamp(),
    updatedBy:auth.currentUser.displayName
  });
}
</script>

</body>
</html>
