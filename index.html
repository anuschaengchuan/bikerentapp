<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family:sans-serif; background:#f2f2f2; margin:0; padding:8px; }
.app { max-width:360px; margin:0 auto; }

.header {
  display:flex; justify-content:space-between; align-items:center;
  background:#fff; padding:12px; border-radius:10px;
  margin-bottom:12px; box-shadow:0 1px 3px rgba(0,0,0,.08);
}
.logo { height:80px; }

.right { display:flex; flex-direction:column; align-items:flex-end; gap:6px; }

.lang-switch { cursor:pointer; display:flex; gap:6px; }
.flag { font-size:20px; }

.actions { display:flex; gap:8px; align-items:center; }

.avatar {
  width:32px; height:32px; border-radius:50%;
  display:none;
}

.btn {
  padding:7px 16px; font-size:13px;
  border-radius:6px; border:1px solid #bbb;
  background:#fff; cursor:pointer;
}
.btn.edit-on { background:#ffecb3; border-color:#ff9800; }

.card {
  background:#fff; border-radius:8px; padding:8px;
  margin-bottom:8px; border:2px solid transparent;
  box-shadow:0 1px 3px rgba(0,0,0,.08);
}
.card.free { background:#e8f5e9; border-color:#4caf50; }
.card.assigned { border-color:#e53935; }
.card.unavailable { background:#eee; border-color:#9e9e9e; }

.name { font-weight:700; margin-bottom:6px; }
.row { display:flex; gap:10px; }
img.bike { width:130px; }

.info { font-size:11px; color:#555; line-height:1.6; }
.info div { margin-bottom:6px; }

.status-btn {
  margin-top:6px;
  padding:6px;
  font-weight:700;
  text-align:center;
  border-radius:6px;
  border:1px solid #999;
  cursor:pointer;
}

.status-menu {
  margin-top:4px;
  border:1px solid #ccc;
  border-radius:6px;
  overflow:hidden;
}
.status-menu div {
  padding:6px;
  cursor:pointer;
}
.status-menu div:hover { background:#eee; }

.updated { font-size:11px; color:#777; margin-top:4px; }

input.date {
  width:100%;
  font-size:11px;
  padding:2px;
}

.warn { color:#ff9800; animation:flash 1.2s infinite; }
.expired { color:#e53935; font-weight:600; }

@keyframes flash {
  0%{opacity:1} 50%{opacity:.3} 100%{opacity:1}
}
</style>
</head>

<body>

<div class="app">

<div class="header">
  <img src="Logo.png" class="logo">

  <div class="right">
    <div class="lang-switch" onclick="toggleLang()">
      <span id="langLabel"></span>
      <span id="langFlag" class="flag"></span>
    </div>

    <div class="actions">
      <img id="avatar" class="avatar">
      <button id="loginBtn" class="btn" onclick="signIn()"></button>
      <button id="logoutBtn" class="btn" onclick="signOut()" style="display:none"></button>
      <button id="editBtn" class="btn" onclick="toggleEdit()" style="display:none">Edit</button>
    </div>
  </div>
</div>

<div id="bikes"></div>

</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* ---------- FIREBASE ---------- */
firebase.initializeApp({
  apiKey:"AIzaSyCqJ-LqV_hn06MhfweOTJGIDmIt5bIq2JI",
  authDomain:"baan-namsai-bikes.firebaseapp.com",
  projectId:"baan-namsai-bikes"
});
const auth = firebase.auth();
const db = firebase.firestore();
const ADMIN_UID = "pK46rxDcvEVZEyktMvc8g2FaCoH2";

/* ---------- DATA ---------- */
const bikes = [
  {id:1,name:"Honda Click",img:"click_redblack.png",plate:"1à¸à¸• 8316"},
  {id:2,name:"Yamaha Fazzio",img:"fazzio_darkgrey.png",plate:"1à¸à¸£ 5287"},
  {id:3,name:"Yamaha Fazzio",img:"fazzio_lightblue.png",plate:"1à¸à¸ž 2670"}
];

let bikeData = {};
let editMode = false;
let openStatusMenu = null;

/* ---------- LANGUAGE ---------- */
let lang = localStorage.getItem("lang") || (navigator.language.startsWith("th")?"th":"en");

const T = {
  en:{
    available:"Available",
    unavailable:"Unavailable",
    tax:"Tax",
    insurance:"Insurance",
    plate:"Plate",
    expired:"Expired",
    days:"days",
    months:"months",
    login:"Login",
    logout:"Logout",
    by:"by",
    min:"min ago",
    hour:"h ago",
    day:"d ago",
    houses:{
      "Baan Mai":"Baan Mai",
      "Baan Nam Lom":"Baan Nam Lom",
      "Baan Mai Pai":"Baan Mai Pai",
      "Baan Makham":"Baan Makham"
    }
  },
  th:{
    available:"à¸§à¹ˆà¸²à¸‡",
    unavailable:"à¹„à¸¡à¹ˆà¸žà¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™",
    tax:"à¸ à¸²à¸©à¸µ",
    insurance:"à¸›à¸£à¸°à¸à¸±à¸™",
    plate:"à¸—à¸°à¹€à¸šà¸µà¸¢à¸™",
    expired:"à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸",
    days:"à¸§à¸±à¸™",
    months:"à¹€à¸”à¸·à¸­à¸™",
    login:"à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š",
    logout:"à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š",
    by:"à¹‚à¸”à¸¢",
    min:"à¸™à¸²à¸—à¸µà¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§",
    hour:"à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡à¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§",
    day:"à¸§à¸±à¸™à¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§",
    houses:{
      "Baan Mai":"à¸šà¹‰à¸²à¸™à¹„à¸¡à¹‰",
      "Baan Nam Lom":"à¸šà¹‰à¸²à¸™à¸¥à¸¡à¹à¸¥à¸°à¸™à¹‰à¸³",
      "Baan Mai Pai":"à¸šà¹‰à¸²à¸™à¹„à¸¡à¹‰à¹„à¸œà¹ˆ",
      "Baan Makham":"à¸šà¹‰à¸²à¸™à¸¡à¸°à¸‚à¸²à¸¡"
    }
  }
};

function toggleLang(){
  lang = lang==="en"?"th":"en";
  localStorage.setItem("lang",lang);
  updateHeader();
  renderAll();
}

function updateHeader(){
  langLabel.innerText = lang==="en"?"à¹„à¸—à¸¢":"English";
  langFlag.innerText = lang==="en"?"ðŸ‡¹ðŸ‡­":"ðŸ‡¬ðŸ‡§";
  loginBtn.innerText = T[lang].login;
  logoutBtn.innerText = T[lang].logout;
}

/* ---------- AUTH ---------- */
auth.onAuthStateChanged(user=>{
  if(user){
    avatar.src=user.photoURL||"";
    avatar.style.display=user.photoURL?"block":"none";
    loginBtn.style.display="none";
    logoutBtn.style.display="inline-block";
    editBtn.style.display=user.uid===ADMIN_UID?"inline-block":"none";
  } else {
    avatar.style.display="none";
    loginBtn.style.display="inline-block";
    logoutBtn.style.display="none";
    editBtn.style.display="none";
    editMode=false;
  }
  updateHeader();
});

function signIn(){ auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
function signOut(){ auth.signOut(); }

function toggleEdit(){
  editMode=!editMode;
  editBtn.classList.toggle("edit-on",editMode);
  renderAll();
}

/* ---------- DATE LOGIC (ROBUST) ---------- */
function parseDateFlexible(str){
  if(!str) return null;

  if(/^\d{2}\/\d{2}\/\d{2}$/.test(str)){
    const [d,m,y]=str.split("/").map(Number);
    return new Date(2000+y,m-1,d);
  }
  if(/^\d{4}-\d{2}-\d{2}$/.test(str)){
    const [y,m,d]=str.split("-").map(Number);
    return new Date(y,m-1,d);
  }
  return null;
}

function formatDDMMYY(date){
  if(!date) return "";
  return (
    String(date.getDate()).padStart(2,"0")+"/"+
    String(date.getMonth()+1).padStart(2,"0")+"/"+
    String(date.getFullYear()).slice(-2)
  );
}

function daysLeft(str){
  const d=parseDateFlexible(str);
  if(!d) return null;
  return Math.ceil((d-new Date())/86400000);
}

function remaining(days){
  if(days===null) return "â€”";
  if(days<0) return T[lang].expired;
  if(days<=60) return days+" "+T[lang].days;
  return Math.round(days/30)+" "+T[lang].months;
}

function timeAgo(ts){
  const s=Math.floor((Date.now()-ts)/1000);
  if(s<3600) return Math.floor(s/60)+" "+T[lang].min;
  if(s<86400) return Math.floor(s/3600)+" "+T[lang].hour;
  return Math.floor(s/86400)+" "+T[lang].day;
}

/* ---------- RENDER ---------- */
const bikesEl=document.getElementById("bikes");

function renderAll(){
  bikesEl.innerHTML=bikes.map(b=>renderBike(b)).join("");
}

function renderBike(b){
  const d=bikeData[b.id]||{};
  const taxDays=daysLeft(d.taxExpiry);
  const insDays=daysLeft(d.insuranceExpiry);

  function line(label,days){
    let cls="";
    if(days!==null){
      if(days<0) cls="expired";
      else if(days<=14) cls="warn";
    }
    return `<div class="${cls}">${label}: ${remaining(days)}</div>`;
  }

  const statusLabel =
    d.status==="Free"?T[lang].available:
    d.status==="Unavailable"?T[lang].unavailable:
    T[lang].houses[d.status]||d.status;

  return `
  <div class="card ${d.status==='Free'?'free':d.status==='Unavailable'?'unavailable':'assigned'}">
    <div class="name">${b.name}</div>

    <div class="row">
      <img src="${b.img}" class="bike">
      <div class="info">
        ${editMode?`
          <div>${T[lang].tax}:
            <input class="date" value="${formatDDMMYY(parseDateFlexible(d.taxExpiry))}"
              placeholder="DD/MM/YY"
              onchange="saveExpiry(${b.id},'taxExpiry',this.value)">
          </div>
          <div>${T[lang].insurance}:
            <input class="date" value="${formatDDMMYY(parseDateFlexible(d.insuranceExpiry))}"
              placeholder="DD/MM/YY"
              onchange="saveExpiry(${b.id},'insuranceExpiry',this.value)">
          </div>
        `:`
          ${line(T[lang].tax,taxDays)}
          ${line(T[lang].insurance,insDays)}
        `}
        <div>${T[lang].plate}: ${b.plate}</div>
      </div>
    </div>

    <div class="status-btn" onclick="toggleStatus(${b.id})">${statusLabel}</div>

    ${openStatusMenu===b.id?`
      <div class="status-menu">
        <div onclick="setStatus(${b.id},'Free')">${T[lang].available}</div>
        ${Object.keys(T[lang].houses).map(h=>`
          <div onclick="setStatus(${b.id},'${h}')">${T[lang].houses[h]}</div>
        `).join("")}
        <div onclick="setStatus(${b.id},'Unavailable')">${T[lang].unavailable}</div>
      </div>
    `:""}

    <div class="updated">
      ${d.updatedAt?`${timeAgo(d.updatedAt)} ${T[lang].by} ${d.updatedBy||""}`:""}
    </div>
  </div>`;
}

/* ---------- FIRESTORE ---------- */
bikes.forEach(b=>{
  db.collection("bikes").doc("bike"+b.id).onSnapshot(doc=>{
    if(doc.exists){
      const data=doc.data();
      bikeData[b.id]={...data,updatedAt:data.updatedAt?.toMillis?.()};
      renderAll();
    }
  });
});

/* ---------- ACTIONS ---------- */
function toggleStatus(id){
  openStatusMenu=openStatusMenu===id?null:id;
  renderAll();
}
function setStatus(id,val){
  if(!auth.currentUser){ signIn(); return; }
  openStatusMenu=null;
  db.collection("bikes").doc("bike"+id).update({
    status:val,
    updatedAt:firebase.firestore.FieldValue.serverTimestamp(),
    updatedBy:auth.currentUser.displayName
  });
}
function saveExpiry(id,field,val){
  if(!editMode) return;
  if(!/^\d{2}\/\d{2}\/\d{2}$/.test(val)) return;
  db.collection("bikes").doc("bike"+id).update({[field]:val});
}

/* INIT */
updateHeader();
renderAll();
</script>

</body>
</html>
