<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family:sans-serif; background:#f2f2f2; margin:0; padding:8px; }
.app { max-width:360px; margin:0 auto; }
.top { text-align:right; font-size:11px; color:#555; margin-bottom:6px; }
.top span { text-decoration:underline; cursor:pointer; margin-left:6px; }

.card {
  background:#fff; border-radius:8px; padding:8px; margin-bottom:8px;
  box-shadow:0 1px 3px rgba(0,0,0,.08); border:2px solid transparent;
}
.card.free { background:#e8f5e9; border-color:#4caf50; }
.card.assigned { border-color:#e53935; }
.card.unavailable { background:#eee; border-color:#9e9e9e; }

.row { display:flex; align-items:center; gap:8px; }
img { width:100%; max-width:130px; }
.name { font-size:13px; font-weight:600; margin-top:4px; }
.updated { font-size:11px; color:#777; margin-top:2px; }
select { width:100%; font-size:13px; padding:4px; }
.info { font-size:11px; color:#555; }

.warn { color:#ff9800; animation:flash 1.2s infinite; }
.expired { color:#e53935; font-weight:600; }

@keyframes flash {
  0%{opacity:1} 50%{opacity:.3} 100%{opacity:1}
}

.edit-btn {
  font-size:11px;
  padding:2px 6px;
  border:1px solid #999;
  border-radius:4px;
  cursor:pointer;
  background:#fff;
}
.edit-on {
  background:#ffecb3;
  border-color:#ff9800;
}
</style>
</head>

<body>

<div class="app">

<div class="top">
  User: <strong id="username">—</strong>
  <span onclick="signIn()">Sign in</span>
  <span onclick="signOut()">Sign out</span>
  <span id="editToggle" style="display:none">
    · <button id="editBtn" class="edit-btn" onclick="toggleEdit()">Edit</button>
  </span>
</div>

<div id="bikes"></div>

</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCqJ-LqV_hn06MhfweOTJGIDmIt5bIq2JI",
  authDomain: "baan-namsai-bikes.firebaseapp.com",
  projectId: "baan-namsai-bikes",
  storageBucket: "baan-namsai-bikes.firebasestorage.app",
  messagingSenderId: "25012885530",
  appId: "1:25012885530:web:112e1ec9855473d6d399a3"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const ADMIN_UID = "pK46rxDcvEVZEyktMvc8g2FaCoH2";
let editMode = false;

const bikes = [
  { id:1, name:"Honda Click", img:"click_redblack.png" },
  { id:2, name:"Yamaha Fazzio", img:"fazzio_darkgrey.png" },
  { id:3, name:"Yamaha Fazzio", img:"fazzio_lightblue.png" }
];

auth.onAuthStateChanged(u=>{
  document.getElementById("username").innerText = u ? u.displayName : "—";
  document.getElementById("editToggle").style.display =
    (u && u.uid===ADMIN_UID) ? "inline" : "none";
});

function signIn(){ auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
function signOut(){ editMode=false; auth.signOut(); }

function toggleEdit(){
  editMode = !editMode;
  document.getElementById("editBtn").classList.toggle("edit-on", editMode);
  rerenderAllExpiry();
}

function daysLeft(d){
  return Math.ceil((new Date(d) - new Date()) / 86400000);
}

function expiryLine(label, field, val, bikeId){
  const days = daysLeft(val);
  let cls="", txt=val;

  if(days < 0){ cls="expired"; txt="Expired"; }
  else if(days <= 14){ cls="warn"; txt = days + " days"; }

  if(editMode){
    return `<div class="${cls}">
      ${label}: <input type="date" value="${val}"
      onchange="updateExpiry('${bikeId}','${field}',this.value)">
    </div>`;
  }
  return `<div class="${cls}">${label}: ${txt}</div>`;
}

function renderBike(b){
  return `
  <div class="card" id="bike${b.id}-card">
    <div class="row">
      <img src="${b.img}">
      <div class="info" id="bike${b.id}-expiry"></div>
    </div>
    <div class="name">${b.name}</div>
    <select onchange="saveStatus(${b.id},this.value)">
      <option value="Free">Free / ว่าง</option>
      <option>Baan Mai / บ้านไม้</option>
      <option>Baan Nam Lom / บ้านลมและน้ำ</option>
      <option>Baan Mai Pai / บ้านไม้ไผ่</option>
      <option>Baan Makham / บ้านมะขาม</option>
      <option value="Unavailable">Unavailable / ไม่พร้อมใช้งาน</option>
    </select>
    <div class="updated" id="bike${b.id}-time"></div>
  </div>`;
}

document.getElementById("bikes").innerHTML =
  bikes.map(renderBike).join("");

bikes.forEach(b=>{
  db.collection("bikes").doc("bike"+b.id).onSnapshot(doc=>{
    if(!doc.exists) return;
    const d = doc.data();

    const card = document.getElementById("bike"+b.id+"-card");
    const sel = card.querySelector("select");

    sel.value = d.status;
    card.classList.remove("free","assigned","unavailable");
    if(d.status==="Free") card.classList.add("free");
    else if(d.status==="Unavailable") card.classList.add("unavailable");
    else card.classList.add("assigned");

    if(d.updatedAt?.toMillis){
      document.getElementById("bike"+b.id+"-time").innerText =
        `Updated ${new Date(d.updatedAt.toMillis()).toLocaleString()} by ${d.updatedBy}`;
    }

    renderExpiryBlock(b.id, d);
  });
});

function renderExpiryBlock(id, d){
  document.getElementById("bike"+id+"-expiry").innerHTML =
    expiryLine("Tax","taxExpiry",d.taxExpiry,"bike"+id) +
    expiryLine("Ins","insuranceExpiry",d.insuranceExpiry,"bike"+id);
}

function rerenderAllExpiry(){
  bikes.forEach(b=>{
    db.collection("bikes").doc("bike"+b.id).get().then(doc=>{
      if(doc.exists) renderExpiryBlock(b.id, doc.data());
    });
  });
}

function saveStatus(id,val){
  if(!auth.currentUser){ alert("Please sign in"); return; }
  db.collection("bikes").doc("bike"+id).update({
    status: val,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedBy: auth.currentUser.displayName
  });
}

function updateExpiry(bikeId, field, val){
  if(!editMode) return;
  db.collection("bikes").doc(bikeId).update({ [field]: val });
}
</script>

</body>
</html>

